# 实验记录2023.3.30

## 分析50x50万笔交易

(arrl) qucheng@gpu01-inspur:~/ARRL$ python test_stack.py --window=50 --step_size=500000 --start_time="2021-07-10 00:00:00"
Real data:
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1625846400
171058
select * from tx where block_number>=12794086
32502763
dropped 38412 contract creation tx, remaining: 32464351
Step: 0
Block number: 12794086 12926367 132281
Blocks: 0 ~ 49  Size: 50
Vertex from: 4534734 Vertex to: 3286471
Vertex: 5535648
Layer: 50it [03:24,  4.10s/it]
Weight: 17it [05:42, 19.98s/it]
Weight: 50it [18:08, 21.78s/it]
Vertex: 5535648 , new vertexes: [212273, 193546, 157475, 164909, 143267, 141315, 136273, 120269, 128244, 121797, 114574, 111675, 105357, 113329, 103695, 102547, 103940, 98233, 98718, 92129, 92597, 93867, 91687, 104556, 89798, 99063, 99238, 97527, 98318, 89638, 99116, 88765, 102825, 96200, 106248, 107048, 92246, 93399, 87058, 94941, 96746, 114298, 148518, 95099, 130530, 105126, 99165, 85598, 90146, 82722]
Edge: 10843089 , layer edges: [319598, 329820, 320207, 338974, 323824, 327699, 318680, 327944, 328780, 319989, 328038, 317435, 330485, 328524, 319146, 331888, 321325, 327377, 330592, 319369, 329860, 319625, 333052, 321453, 321173, 332074, 328289, 334546, 322044, 334707, 331781, 331277, 338726, 324361, 349970, 329326, 330219, 335682, 321637, 335525, 317004, 347347, 364363, 336688, 372473, 335354, 343526, 330977, 329576, 348096] , new edges: [319598, 305394, 276944, 277329, 262263, 251852, 244141, 239658, 233381, 237474, 216172, 224722, 225193, 219547, 222337, 205007, 216907, 204711, 202127, 204454, 204352, 208881, 188609, 207245, 191621, 195168, 206764, 190698, 205902, 190272, 203627, 194681, 199848, 203486, 200403, 210751, 195075, 189504, 187073, 188787, 196834, 209339, 245772, 214222, 233270, 214291, 204808, 187062, 203064, 182469] sum 10843089
vweights sum: [[1000000 1000000 1000000 1000000 1000000 1000000 1000000 1000000 1000000
  1000000 1000000 1000000 1000000 1000000 1000000 1000000 1000000 1000000
  1000000 1000000 1000000 1000000 1000000 1000000 1000000 1000000 1000000
  1000000 1000000 1000000 1000000 1000000 1000000 1000000 1000000 1000000
  1000000 1000000 1000000 1000000 1000000 1000000 1000000 1000000 1000000
  1000000 1000000 1000000 1000000 1000000]] new vweights sum: [[1000000  378063  312591  291407  270912  252265  244481  219970  220124
   221321  192868  201919  193029  194601  196103  181355  193574  167477
   172599  168814  162630  172169  156198  179111  154863  164339  174978
   160475  170589  159354  175344  160704  177608  168318  182980  181679
   154742  157887  148368  154722  165003  167049  209491  161910  196497
   169163  159102  143928  157397  136693]] prop: [[1.       0.378063 0.312591 0.291407 0.270912 0.252265 0.244481 0.21997
  0.220124 0.221321 0.192868 0.201919 0.193029 0.194601 0.196103 0.181355
  0.193574 0.167477 0.172599 0.168814 0.16263  0.172169 0.156198 0.179111
  0.154863 0.164339 0.174978 0.160475 0.170589 0.159354 0.175344 0.160704
  0.177608 0.168318 0.18298  0.181679 0.154742 0.157887 0.148368 0.154722
  0.165003 0.167049 0.209491 0.16191  0.196497 0.169163 0.159102 0.143928
  0.157397 0.136693]]
vweights mean: [[4.71091472 4.36681223 4.72130157 4.24583378 4.63768116 4.46305041
  4.55522758 4.65948485 4.34920649 4.71606906 4.32398775 4.61527101
  4.61303552 4.27410703 4.78615461 4.26872476 4.58991412 4.50765174
  4.36502047 4.76319763 4.5150396  4.83383686 4.25454066 4.47273199
  4.59768001 4.19116753 4.51135282 4.09495379 4.45329165 4.34161569
  4.26204774 4.46586073 4.04512744 4.50247636 3.92722075 4.27244529
  4.34497352 4.13458915 4.54506202 4.04079588 4.39674465 3.85291126
  3.54470403 4.24855761 3.44827586 4.07058393 4.07948468 4.14356628
  4.4594679  3.97721849]] new vweights mean: [[4.71091472 1.95334959 1.98501984 1.7670776  1.89095884 1.78512543
  1.79405311 1.82898336 1.71644677 1.81713014 1.68334875 1.80809492
  1.83214215 1.7171333  1.89115194 1.76850615 1.8623629  1.7048955
  1.74840455 1.83236549 1.7563204  1.83418028 1.70360029 1.71306286
  1.7245707  1.65893421 1.7632157  1.64544178 1.73507394 1.77775051
  1.76907866 1.81044331 1.72728422 1.74966736 1.72219712 1.69717323
  1.67749279 1.69045707 1.70424315 1.62966474 1.70552788 1.46152164
  1.41054283 1.70254156 1.50537807 1.60914522 1.60441688 1.68144116
  1.74602312 1.65243829]]
weights sum: [[500000 500000 500000 500000 500000 500000 500000 500000 500000 500000
  500000 500000 500000 500000 500000 500000 500000 500000 500000 500000
  500000 500000 500000 500000 500000 500000 500000 500000 500000 500000
  500000 500000 500000 500000 500000 500000 500000 500000 500000 500000
  500000 500000 500000 500000 500000 500000 500000 500000 500000 500000]] new weights sum: [[500000 373190 337476 325523 314220 295915 284287 278235 267955 275125
  246956 256853 260239 254251 262657 243343 253954 239928 237287 245131
  238488 247332 218541 237630 222110 221196 237633 217506 234290 221184
  240704 230190 231002 234927 227244 245635 226727 219188 219055 212408
  225001 233639 266707 245950 253671 241564 231571 211861 231875 202599]] prop: [[1.       0.74638  0.674952 0.651046 0.62844  0.59183  0.568574 0.55647
  0.53591  0.55025  0.493912 0.513706 0.520478 0.508502 0.525314 0.486686
  0.507908 0.479856 0.474574 0.490262 0.476976 0.494664 0.437082 0.47526
  0.44422  0.442392 0.475266 0.435012 0.46858  0.442368 0.481408 0.46038
  0.462004 0.469854 0.454488 0.49127  0.453454 0.438376 0.43811  0.424816
  0.450002 0.467278 0.533414 0.4919   0.507342 0.483128 0.463142 0.423722
  0.46375  0.405198]]
weights mean: [[1.56446536 1.51597841 1.56148991 1.47503938 1.54404862 1.52579044
  1.56897201 1.52465055 1.52077377 1.56255371 1.52421366 1.57512562
  1.51292797 1.52195882 1.56668108 1.50653232 1.55605695 1.52729117
  1.51243829 1.56558714 1.51579458 1.5643332  1.50126707 1.55543734
  1.55679338 1.50568849 1.52304829 1.49456278 1.55258288 1.49384387
  1.50701818 1.50931094 1.47611934 1.54149235 1.42869389 1.51825243
  1.51414667 1.48950495 1.55454752 1.49020192 1.57726716 1.43948271
  1.37225789 1.48505441 1.34237918 1.49096179 1.45549391 1.51067899
  1.51710076 1.43638536]] new weights mean: [[1.56446536 1.22199519 1.21857126 1.17377916 1.19811029 1.17495593
  1.16443776 1.16096688 1.14814402 1.15854788 1.14240512 1.14298111
  1.15562651 1.15807094 1.18134633 1.18699849 1.1707967  1.17203277
  1.17395004 1.19895429 1.1670451  1.18408089 1.15869868 1.14661391
  1.15911095 1.13336203 1.14929582 1.1405783  1.13787141 1.16246216
  1.18208293 1.18239582 1.15588848 1.15451186 1.13393512 1.16552235
  1.16225554 1.15664049 1.17096    1.12511984 1.14310028 1.11607966
  1.08518057 1.14810804 1.0874566  1.12727086 1.13067361 1.13257102
  1.14188138 1.11032011]]
weights max: [3320. 2128. 1247. 1770. 1301. 5908. 5574. 1292. 4393. 2412. 5263. 2812.
 1389. 1940. 1342. 2364. 1620. 2392. 2824. 1464. 1076. 1295. 2475. 2826.
 1543. 1551. 1335. 1570. 1964. 1311. 1534. 1195. 1734. 2495. 1773. 1506.
 2818. 1335. 1129. 1884. 2570. 1616. 1831. 1311. 1489. 1722. 2623. 2252.
 1307. 1575.] new weights max: [3320. 1391.  239.  276.  297.  453. 2788.  190.  141.  476.  594.  234.
  163.  851.  648.  812.   68.  287.  176.  550.  224.  167.  261.   82.
  151.   62.  145.  100.   94.   49.  458.  154.  455.  115.   69.  537.
  255.  100.  242.  181. 1341.  189.  223.  101.  136.   90.  125.  159.
  230.  130.]
weights min: [1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.
 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.
 1. 1.] new weights min: [1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.
 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.
 1. 1.]
                                 OLS Regression Results                                
=======================================================================================
Dep. Variable:                      y   R-squared (uncentered):                   0.888
Model:                            OLS   Adj. R-squared (uncentered):              0.888
Method:                 Least Squares   F-statistic:                          1.783e+06
Date:                Thu, 30 Mar 2023   Prob (F-statistic):                        0.00
Time:                        11:23:56   Log-Likelihood:                     -8.6867e+06
No. Observations:            10843089   AIC:                                  1.737e+07
Df Residuals:                10843041   BIC:                                  1.737e+07
Df Model:                          48                                                  
Covariance Type:            nonrobust                                                  
==============================================================================
                 coef    std err          t      P>|t|      [0.025      0.975]
------------------------------------------------------------------------------
0              0.0014      0.000      8.743      0.000       0.001       0.002
1             -0.0259      0.000    -96.432      0.000      -0.026      -0.025
2              0.1248      0.000    373.301      0.000       0.124       0.125
3              0.0283      0.000     87.161      0.000       0.028       0.029
4             -0.0217      0.000    -66.110      0.000      -0.022      -0.021
5             -0.0253      0.000   -139.354      0.000      -0.026      -0.025
6             -0.0050      0.000    -31.711      0.000      -0.005      -0.005
7              0.0585      0.000    194.434      0.000       0.058       0.059
8              0.0326      0.000    189.766      0.000       0.032       0.033
9             -0.0661      0.000   -215.009      0.000      -0.067      -0.065
10            -0.1009      0.000   -367.869      0.000      -0.101      -0.100
11             0.0188      0.000     90.450      0.000       0.018       0.019
12            -0.0642      0.000   -220.306      0.000      -0.065      -0.064
13            -0.0032      0.000    -12.229      0.000      -0.004      -0.003
14             0.1604      0.000    544.210      0.000       0.160       0.161
15            -0.0362      0.000   -168.646      0.000      -0.037      -0.036
16            -0.0192      0.000    -60.065      0.000      -0.020      -0.019
17             0.0558      0.000    180.988      0.000       0.055       0.056
18            -0.0268      0.000    -76.200      0.000      -0.027      -0.026
19            -0.0385      0.000   -153.996      0.000      -0.039      -0.038
20             0.0191      0.000     72.727      0.000       0.019       0.020
21             0.0043      0.000     13.062      0.000       0.004       0.005
22            -0.0094      0.000    -42.289      0.000      -0.010      -0.009
23            -0.0673      0.000   -204.942      0.000      -0.068      -0.067
24             0.0422      0.000    145.186      0.000       0.042       0.043
25            -0.0149      0.000    -43.245      0.000      -0.016      -0.014
26             0.0617      0.000    190.703      0.000       0.061       0.062
27            -0.0546      0.000   -165.562      0.000      -0.055      -0.054
28             0.0543      0.000    174.910      0.000       0.054       0.055
29            -0.0098      0.000    -30.640      0.000      -0.010      -0.009
30            -0.0019      0.000     -5.133      0.000      -0.003      -0.001
31            -0.0434      0.000   -131.937      0.000      -0.044      -0.043
32             0.0081      0.000     29.554      0.000       0.008       0.009
33             0.0766      0.000    213.015      0.000       0.076       0.077
34            -0.0060      0.000    -16.024      0.000      -0.007      -0.005
35             0.0335      0.000    109.215      0.000       0.033       0.034
36            -0.0126      0.000    -41.788      0.000      -0.013      -0.012
37            -0.0116      0.000    -32.056      0.000      -0.012      -0.011
38             0.0591      0.000    167.976      0.000       0.058       0.060
39             0.0196      0.000     59.406      0.000       0.019       0.020
40             0.1161      0.000    511.221      0.000       0.116       0.117
41            -0.0631      0.000   -235.714      0.000      -0.064      -0.063
42            -0.0046      0.000    -16.656      0.000      -0.005      -0.004
43             0.2338      0.000    685.734      0.000       0.233       0.234
44             0.0017      0.000      4.393      0.000       0.001       0.002
45             0.1184      0.000    366.426      0.000       0.118       0.119
46             0.3078      0.000   1168.298      0.000       0.307       0.308
47             0.0763      0.000    739.822      0.000       0.076       0.076
================================================================================
Omnibus:                 41627529.421   Durbin-Watson:                     1.754
Prob(Omnibus):                  0.000   Jarque-Bera (JB):   2653994750499589.500
Skew:                          87.892   Prob(JB):                           0.00
Kurtosis:                   76646.971   Cond. No.                           28.0
================================================================================

Notes:
[1] R² is computed without centering (uncentered) since the model does not contain a constant.
[2] Standard Errors assume that the covariance matrix of the errors is correctly specified.
MSE: 0.6496941184831504

## 修正PryClient reset后的结果

```sh
(arrl) qucheng@gpu01-inspur:~/ARRL$ python test_graph.py table --method=history --client=pry
Namespace(funcs=['table'], method=['history'], past=[20], k=3, g=10, tx_rate=100, n_blocks=10, tx_per_block=200, block_interval=15, start_time='2021-08-01 00:00:00', end_time=None, client='pry')
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627747200
30874
select * from tx where block_number>=12934270
5939599
dropped 5757 contract creation tx, remaining: 5933842
Account graph & Table allocate:
Table updated with all history txs partition:
100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍| 394/395 [1:06:28<00:10, 10.12s/it]
{'n_shards': 8, 'blocks_per_epoch': 10, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 59250, 'n_block': 31600, 'target_n_block': 31600.0, 'n_tx': 5925000, 'n_inner_tx': 3183892, 'n_cross_tx': 2741108, 'prop_cross_tx': 0.4626342616033755, 'n_block_tx': 6317517, 'n_block_out_tx': 2035670, 'n_block_forward_tx': 2035173, 'n_block_inner_tx': 2246674, 'throughput': 106.62475949367088, 'actual_throughput': 72.26745991561181, 'target_throughput': 106.66666666666667, 'tx_pool_length': [168932, 205605, 347001, 122263, 314504, 271900, 101120, 111331], 'tx_forward_length': [119, 50, 68, 42, 74, 57, 23, 64], 'n_wasted': 2483, 'tx_wasted': [0, 0, 0, 784, 0, 0, 1699, 0], 'prop_wasted': 0.00039287974683544305, 'prop_throughput': 0.6775074367088607}
```

速率修改为70

```sh
(arrl) qucheng@gpu01-inspur:~/ARRL$ python test_graph.py table --method=history --client=pry --tx_rate=70
Namespace(funcs=['table'], method=['history'], past=[20], k=3, g=10, tx_rate=70, n_blocks=10, tx_per_block=200, block_interval=15, start_time='2021-08-01 00:00:00', end_time=None, client='pry')
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627747200
30874
select * from tx where block_number>=12934270
5939599
dropped 5757 contract creation tx, remaining: 5933842
Account graph & Table allocate:
Table updated with all history txs partition:
100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌| 564/565 [1:31:00<00:09,  9.68s/it]
{'n_shards': 8, 'blocks_per_epoch': 10, 'tx_rate': 70, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 84750, 'n_block': 45200, 'target_n_block': 45200.0, 'n_tx': 5932500, 'n_inner_tx': 3216279, 'n_cross_tx': 2716221, 'prop_cross_tx': 0.4578543615676359, 'n_block_tx': 8425717, 'n_block_out_tx': 2648204, 'n_block_forward_tx': 2647739, 'n_block_inner_tx': 3129774, 'throughput': 99.41848967551623, 'actual_throughput': 68.17124483775811, 'target_throughput': 106.66666666666667, 'tx_pool_length': [1487, 2782, 81935, 1783, 40270, 22393, 3739, 133], 'tx_forward_length': [44, 57, 37, 55, 29, 70, 12, 161], 'n_wasted': 614283, 'tx_wasted': [103616, 66526, 218, 133773, 1263, 5268, 131570, 172049], 'prop_wasted': 0.0679516592920354, 'prop_throughput': 0.6391054203539822}
```

```sh
(arrl) qucheng@gpu01-inspur:~/ARRL$ python test_graph.py table --method=none --tx_rate=70
Namespace(funcs=['table'], method=['none'], past=[20], k=3, g=10, tx_rate=70, n_blocks=10, tx_per_block=200, block_interval=15, start_time='2021-08-01 00:00:00', end_time=None, client='normal')
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627747200
30874
select * from tx where block_number>=12934270
5939599
dropped 5757 contract creation tx, remaining: 5933842
Account graph & Table allocate:
Empty table:
100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 565/565 [00:15<00:00, 36.14it/s]
{'n_shards': 8, 'blocks_per_epoch': 10, 'tx_rate': 70, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 84750, 'n_block': 45200, 'target_n_block': 45200.0, 'n_tx': 5932500, 'n_inner_tx': 905230, 'n_cross_tx': 5027270, 'prop_cross_tx': 0.8474117151285293, 'n_block_tx': 8927990, 'n_block_out_tx': 4130047, 'n_block_forward_tx': 4129352, 'n_block_inner_tx': 668591, 'throughput': 105.34501474926253, 'actual_throughput': 56.61289675516224, 'target_throughput': 106.66666666666667, 'tx_pool_length': [40915, 63350, 353828, 0, 1018, 411344, 2313, 261094], 'tx_forward_length': [63, 66, 66, 53, 102, 114, 79, 152], 'n_wasted': 112010, 'tx_wasted': [2601, 2847, 0, 89018, 15612, 0, 1658, 274], 'prop_wasted': 0.012390486725663718, 'prop_throughput': 0.530745907079646}
```

## 思考

1. 进行分割算法的时候，使用的交易是所有历史提交的交易，其中包括了交易池中尚未进行打包的交易
2. 智能客户端在为账户分配地址时，使用的是当前分配方案作为参考，而事实上由于交易池中仍存在交易，新账户并不一定在下一轮中得到打包

计划：

1. 对比只用已打包的交易进行划分的效果，对比只用交易池中的交易进行划分的效果。
2. 尝试分布式算法。

对比算法，说明当交易发送速率接近处理能力的时候，且单个周期的持续时间较长的时候，下个阶段中的大部分交易不会出现在当前的交易池中。


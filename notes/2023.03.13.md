# 实验记录2023.3.13

## 使用过去4个step（单步10个区块）预测后一步的交易

训练数据：2021-07-31 00:00:00-2021-08-01 00:00:00  
测试数据：2021-08-01 00:00:00-  
不进行预测：  
训练数据上的效果：

```sh
Namespace(funcs=['graph'], method=['past'], past=[4], k=3, g=10, tx_rate=100, n_blocks=10, start_time='2021-07-31 00:00:00', end_time='2021-08-01 00:00:00')
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627660800 and timestamp<=1627747200
6346
select * from tx where block_number>=12927924 and block_number<=12934269
1222419
dropped 1239 contract creation tx, remaining: 1221180
Account Graph:
Partition with past 4 steps txs:
 94%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                | 76/81 [04:20<00:17,  3.43s/it]
{'n_shards': 8, 'blocks_per_epoch': 10, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 11550, 'n_block': 6160, 'target_n_block': 6160.0, 'n_tx': 1155000, 'n_inner_tx': 376939, 'n_cross_tx': 778061, 'prop_cross_tx': 0.6736458874458875, 'n_block_tx': 1232000, 'n_block_out_tx': 493590, 'n_block_forward_tx': 492992, 'n_block_inner_tx': 245418, 'throughput': 106.66666666666667, 'actual_throughput': 63.93160173160173, 'target_throughput': 106.66666666666667, 'tx_pool_length': [64369, 54100, 51501, 55872, 45629, 48271, 43203, 53047], 'tx_forward_length': [91, 74, 75, 99, 67, 57, 73, 62], 'n_wasted': 0, 'tx_wasted': [0, 0, 0, 0, 0, 0, 0, 0], 'prop_wasted': 0.0, 'prop_throughput': 0.5993587662337662}
```

测试数据上的效果：

```sh
select * from block where timestamp>=1627747200
30874
select * from tx where block_number>=12934270
5939599
dropped 5757 contract creation tx, remaining: 5933842
Account Graph:
Partition with past 4 steps txs:
 99%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋   | 390/395 [22:56<00:17,  3.53s/it]
{'n_shards': 8, 'blocks_per_epoch': 10, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 58650, 'n_block': 31280, 'target_n_block': 31280.0, 'n_tx': 5865000, 'n_inner_tx': 1997706, 'n_cross_tx': 3867294, 'prop_cross_tx': 0.6593851662404092, 'n_block_tx': 6255920, 'n_block_out_tx': 2488662, 'n_block_forward_tx': 2488032, 'n_block_inner_tx': 1279226, 'throughput': 106.66530264279625, 'actual_throughput': 64.23287297527706, 'target_throughput': 106.66666666666667, 'tx_pool_length': [343110, 283976, 282248, 291408, 232546, 230465, 208257, 225102], 'tx_forward_length': [82, 92, 70, 73, 77, 70, 87, 79], 'n_wasted': 80, 'tx_wasted': [0, 0, 0, 0, 0, 14, 0, 66], 'prop_wasted': 1.2787723785166241e-05, 'prop_throughput': 0.6021831841432225}
```

进行训练&预测：

```sh
Namespace(k=3, tx_rate=100, n_blocks=10, window=5)
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627660800 and timestamp<=1627747199
6346
select * from tx where block_number>=12927924 and block_number<=12934269
1222419
select * from block where timestamp>=1627747200
30874
select * from tx where block_number>=12934270
5939599
dropped 1239 contract creation tx, remaining: 1221180
dropped 5757 contract creation tx, remaining: 5933842
Account prediction:
Training prediction model: 1221180 1215000
Blocks: [ 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23
 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47
 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71
 72 73 74 75 76 77 78 79 80]  Size: 81
Vertex from: 395834 Vertex to: 287978
Vertex: 528214
Layer: 81it [00:05, 14.57it/s]
Edge: 1215000 , layer edges: [11237, 11871, 11881, 11952, 11992, 11929, 12688, 12044, 12207, 12177, 12158, 12151, 12426, 11616, 12034, 11619, 12047, 12298, 12314, 11987, 12060, 12470, 11918, 11902, 12205, 12128, 11498, 11970, 12346, 11894, 11782, 12463, 12872, 12070, 12811, 12423, 12455, 13206, 12591, 12472, 12369, 12314, 12749, 12454, 12413, 12243, 12756, 12450, 11930, 12289, 12264, 13195, 12932, 13195, 12635, 12410, 13059, 12861, 12659, 12702, 12560, 12329, 12017, 12450, 12521, 11995, 12493, 12382, 12309, 12320, 12567, 12031, 12235, 12423, 12073, 12614, 12438, 12050, 12498, 12549, 12371] , new edges: [15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000] sum 1215000
Train model: (791820, 81)
Train score: 0.2541950148358244 Coef: [0.12803374 0.12646375 0.14693792 0.28882514] Intercept: 0.0
Simulate on train txs: 1221180
 99%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌   | 76/77 [05:25<00:04,  4.28s/it]
{'n_shards': 8, 'blocks_per_epoch': 10, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 11550, 'n_block': 6160, 'target_n_block': 6160.0, 'n_tx': 1155000, 'n_inner_tx': 365912, 'n_cross_tx': 789088, 'prop_cross_tx': 0.6831930735930736, 'n_block_tx': 1232000, 'n_block_out_tx': 498295, 'n_block_forward_tx': 497670, 'n_block_inner_tx': 236035, 'throughput': 106.66666666666667, 'actual_throughput': 63.52424242424242, 'target_throughput': 106.66666666666667, 'tx_pool_length': [69307, 59048, 59227, 56635, 52785, 45588, 36714, 41366], 'tx_forward_length': [83, 97, 79, 91, 78, 61, 69, 67], 'n_wasted': 0, 'tx_wasted': [0, 0, 0, 0, 0, 0, 0, 0], 'prop_wasted': 0.0, 'prop_throughput': 0.5955397727272727}
MSE: 0.053686727908041736 0.441959818392665 0.02887358321070138
Real MSE: 0.10510472831454873 0.441959818392665 0.02887358321070138
Simulate on test txs: 5933842
Blocks: [  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17
  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35
  36  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53
  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71
  72  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87  88  89
  90  91  92  93  94  95  96  97  98  99 100 101 102 103 104 105 106 107
 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125
 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143
 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161
 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179
 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197
 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215
 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233
 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251
 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269
 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287
 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305
 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323
 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341
 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359
 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377
 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394]  Size: 395
Vertex from: 1428298 Vertex to: 1108120
Vertex: 1843370
Layer: 395it [00:46,  8.56it/s]
Edge: 5925000 , layer edges: [12268, 12735, 11547, 12620, 12159, 12504, 12593, 11797, 11722, 11839, 12110, 12315, 11995, 12214, 12143, 11636, 11696, 12177, 12199, 12271, 12398, 12116, 12121, 11971, 12247, 11835, 11887, 11948, 12304, 12117, 12442, 12512, 12449, 12549, 12281, 12308, 12429, 11794, 12374, 12244, 12624, 12407, 11127, 12371, 12492, 12422, 12018, 12172, 11888, 12172, 11573, 12759, 12545, 12973, 13076, 12524, 12815, 12690, 12285, 12136, 12044, 12173, 12633, 12150, 12138, 12312, 12240, 12238, 11823, 12144, 12447, 11926, 12143, 12245, 12109, 11856, 11957, 11876, 12192, 11870, 11354, 11898, 11974, 11818, 12103, 12061, 12348, 11962, 12152, 12505, 12755, 11942, 12047, 11913, 11864, 12447, 12217, 12189, 12357, 12034, 11670, 12122, 12365, 11367, 11681, 11751, 12301, 11445, 12252, 11868, 12142, 12465, 13198, 12996, 12317, 12352, 12143, 12131, 11975, 12456, 12512, 12508, 13082, 12233, 12917, 12359, 11882, 11894, 10709, 11785, 12370, 13072, 12246, 13368, 12130, 12843, 12616, 12844, 12535, 12286, 12213, 12288, 12940, 11950, 11329, 12041, 11098, 12279, 12426, 12333, 12600, 12573, 12311, 12581, 11474, 12059, 12217, 12114, 12145, 12606, 11837, 12308, 12434, 10261, 11434, 11691, 11398, 11807, 11429, 11323, 12082, 10858, 10559, 11446, 11524, 11423, 11919, 11576, 11849, 11474, 11486, 12071, 12153, 11547, 11955, 11621, 11892, 12176, 11932, 11799, 11576, 12065, 11997, 11706, 11487, 11242, 12483, 12376, 12667, 11900, 12215, 12323, 12450, 12309, 12386, 11395, 11995, 12551, 12328, 11969, 11971, 12577, 12381, 12181, 12248, 12431, 12883, 12747, 12964, 12741, 12825, 12864, 12722, 12212, 12285, 11930, 11578, 12100, 11549, 12236, 12409, 11408, 12051, 12076, 11927, 11881, 11981, 11922, 11588, 11918, 11905, 12162, 12310, 12183, 11978, 12087, 12152, 12370, 11917, 12171, 12133, 11714, 11972, 11681, 11245, 11517, 12063, 12026, 12002, 12238, 11825, 12043, 12369, 12411, 12349, 11867, 11975, 12214, 12010, 12396, 11542, 11586, 12141, 11872, 12442, 11711, 12556, 12956, 12924, 12245, 11968, 12467, 12606, 12541, 12136, 12557, 12133, 11535, 11894, 11955, 12127, 12237, 11932, 12433, 12150, 12805, 12591, 12533, 13143, 12388, 12864, 12556, 12544, 12627, 12072, 11692, 11947, 11765, 12019, 12296, 12106, 11963, 12155, 11592, 11534, 11748, 12035, 12125, 12032, 11933, 12141, 11999, 11548, 11946, 12364, 11914, 12162, 11966, 11700, 12099, 11977, 11955, 12224, 11729, 12043, 11091, 11571, 11914, 11243, 12094, 11833, 11918, 11667, 11684, 11464, 11603, 12088, 11439, 11217, 12027, 11487, 11923, 11472, 11773, 11969, 11908, 12507, 11916, 12811, 12971, 12746, 12492, 12515, 12029, 11306, 11180, 11674, 12110, 11573, 11574, 11743, 11902, 11766, 11984, 12237, 11829, 12438, 13287, 12806, 12872, 12431, 12334, 12657, 12029, 12598, 11911, 12306, 12100, 11942, 11446, 12078, 11932, 11906, 11952, 11390] , new edges: [15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000] sum 5925000
██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 391/391 [1:11:22<00:00, 10.95s/it]
{'n_shards': 8, 'blocks_per_epoch': 10, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 58650, 'n_block': 31280, 'target_n_block': 31280.0, 'n_tx': 5865000, 'n_inner_tx': 1952166, 'n_cross_tx': 3912834, 'prop_cross_tx': 0.6671498721227621, 'n_block_tx': 6255290, 'n_block_out_tx': 2512899, 'n_block_forward_tx': 2512200, 'n_block_inner_tx': 1230191, 'throughput': 106.65456095481672, 'actual_throughput': 63.8088832054561, 'target_throughput': 106.66666666666667, 'tx_pool_length': [350623, 295748, 285477, 273534, 237043, 217204, 211813, 250468], 'tx_forward_length': [61, 152, 61, 103, 58, 117, 92, 55], 'n_wasted': 710, 'tx_wasted': [0, 0, 0, 0, 470, 240, 0, 0], 'prop_wasted': 0.00011349104859335039, 'prop_throughput': 0.5982082800511509}
MSE: 0.03517208460230913 0.6464380265636016 0.006841973196247099
Real MSE: 0.047657889132513155 0.6464380265636016 0.006841973196247099
```

训练数据：  
跨片交易比例：不预测：0.6736458874458875，预测：0.6831930735930736  
吞吐量：不预测：63.93160173160173，预测：63.52424242424242  
测试数据：  
跨片交易比例：不预测：0.6593851662404092，预测：0.6671498721227621  
吞吐量：不预测：64.23287297527706，预测：63.8088832054561  

预测后结果反而变差，需要进一步检查。也许是数据线性特征不明显，放大单步长度再试。

## 单步长度设为50个区块，测试线性模型的预测效果

不经过预测的结果：
```sh
(arrl) qucheng@gpu01-inspur:~/ARRL$ python test_graph.py graph --method=past --past=4 --start_time="2021-07-31 00:00:00" --end_time="2021-08-01 00:00:00" --n_blocks=50
Namespace(funcs=['graph'], method=['past'], past=[4], k=3, g=10, tx_rate=100, n_blocks=50, start_time='2021-07-31 00:00:00', end_time='2021-08-01 00:00:00')
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627660800 and timestamp<=1627747200
6346
select * from tx where block_number>=12927924 and block_number<=12934269
1222419
dropped 1239 contract creation tx, remaining: 1221180
Account Graph:
Partition with past 4 steps txs:
 69%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                                 | 11/16 [03:24<01:33, 18.62s/it]
{'n_shards': 8, 'blocks_per_epoch': 50, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 9000, 'n_block': 4800, 'target_n_block': 4800.0, 'n_tx': 900000, 'n_inner_tx': 300932, 'n_cross_tx': 599068, 'prop_cross_tx': 0.6656311111111111, 'n_block_tx': 960000, 'n_block_out_tx': 382271, 'n_block_forward_tx': 381587, 'n_block_inner_tx': 196142, 'throughput': 106.66666666666667, 'actual_throughput': 64.19211111111112, 'target_throughput': 106.66666666666667, 'tx_pool_length': [36420, 34602, 40514, 42686, 52067, 47626, 36333, 31339], 'tx_forward_length': [83, 95, 70, 66, 140, 49, 135, 46], 'n_wasted': 0, 'tx_wasted': [0, 0, 0, 0, 0, 0, 0, 0], 'prop_wasted': 0.0, 'prop_throughput': 0.6018010416666667}
(arrl) qucheng@gpu01-inspur:~/ARRL$ python test_graph.py graph --method=past --past=4 --start_time="2021-08-01 00:00:00" --n_blocks=50
Namespace(funcs=['graph'], method=['past'], past=[4], k=3, g=10, tx_rate=100, n_blocks=50, start_time='2021-08-01 00:00:00', end_time=None)
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627747200
30874
select * from tx where block_number>=12934270
5939599
dropped 5757 contract creation tx, remaining: 5933842
Account Graph:
Partition with past 4 steps txs:
 94%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                | 74/79 [21:32<01:27, 17.46s/it]
{'n_shards': 8, 'blocks_per_epoch': 50, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 56250, 'n_block': 30000, 'target_n_block': 30000.0, 'n_tx': 5625000, 'n_inner_tx': 1990727, 'n_cross_tx': 3634273, 'prop_cross_tx': 0.6460929777777777, 'n_block_tx': 6000000, 'n_block_out_tx': 2365280, 'n_block_forward_tx': 2364666, 'n_block_inner_tx': 1270054, 'throughput': 106.66666666666667, 'actual_throughput': 64.61724444444444, 'target_throughput': 106.66666666666667, 'tx_pool_length': [286168, 260575, 263238, 234364, 293624, 248030, 205499, 198168], 'tx_forward_length': [61, 102, 81, 74, 68, 89, 107, 32], 'n_wasted': 0, 'tx_wasted': [0, 0, 0, 0, 0, 0, 0, 0], 'prop_wasted': 0.0, 'prop_throughput': 0.6057866666666666}
```

经过预测的结果：

```sh
(arrl) qucheng@gpu01-inspur:~/ARRL$ python test_prediction.py --window=5 --n_blocks=50
Namespace(k=3, tx_rate=100, n_blocks=50, window=5)
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627660800 and timestamp<=1627747199
6346
select * from tx where block_number>=12927924 and block_number<=12934269
1222419
select * from block where timestamp>=1627747200
30874
select * from tx where block_number>=12934270
5939599
dropped 1239 contract creation tx, remaining: 1221180
dropped 5757 contract creation tx, remaining: 5933842
Account prediction:
Training prediction model: 1221180 1200000
Blocks: [ 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15]  Size: 16
Vertex from: 391821 Vertex to: 284874
Vertex: 523198
Layer: 16it [00:05,  2.92it/s]
Edge: 1200000 , layer edges: [53550, 55716, 54911, 54377, 54983, 54207, 56980, 58006, 57372, 56417, 59842, 59043, 56852, 56283, 55849, 57282] , new edges: [75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000] sum 1200000
Train model: (782749, 16)
Train score: 0.5774637238929875 Coef: [0.07359044 0.15753768 0.15459072 0.47324352] Intercept: 0.0
Simulate on train txs: 1221180
 92%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                     | 11/12 [03:50<00:20, 20.96s/it]
{'n_shards': 8, 'blocks_per_epoch': 50, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 9000, 'n_block': 4800, 'target_n_block': 4800.0, 'n_tx': 900000, 'n_inner_tx': 293286, 'n_cross_tx': 606714, 'prop_cross_tx': 0.6741266666666667, 'n_block_tx': 960000, 'n_block_out_tx': 387659, 'n_block_forward_tx': 386984, 'n_block_inner_tx': 185357, 'throughput': 106.66666666666667, 'actual_throughput': 63.593444444444444, 'target_throughput': 106.66666666666667, 'tx_pool_length': [48229, 46531, 45724, 40178, 35865, 50745, 28439, 31273], 'tx_forward_length': [107, 117, 95, 97, 20, 47, 60, 132], 'n_wasted': 0, 'tx_wasted': [0, 0, 0, 0, 0, 0, 0, 0], 'prop_wasted': 0.0, 'prop_throughput': 0.5961885416666667}
MSE: 0.41887933006652406 0.6969477036745229 0.24043892021224358
Baseline MSE: 0.47690098720449764 0.9043872940112347 0.31216919472270166
Real MSE: 0.6547433042605825 0.6969477036745229 0.24043892021224358
Simulate on test txs: 5933842
Blocks: [ 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23
 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47
 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71
 72 73 74 75 76 77 78]  Size: 79
Vertex from: 1428298 Vertex to: 1108120
Vertex: 1843370
Layer: 79it [00:45,  1.73it/s]
Edge: 5925000 , layer edges: [56360, 55061, 55400, 54195, 55178, 53807, 56968, 56064, 56040, 55490, 58926, 57961, 55911, 55401, 55731, 53944, 52915, 55198, 54594, 55896, 53000, 53796, 58264, 56266, 58901, 53849, 58833, 58469, 55916, 55241, 56799, 55604, 53416, 52960, 50960, 52773, 53639, 54110, 52947, 55635, 56274, 54976, 56576, 59412, 58120, 54129, 54091, 53642, 54881, 55413, 53725, 54300, 55555, 55003, 53886, 57391, 56720, 54346, 55430, 58778, 57868, 54323, 53620, 53794, 54186, 54511, 54734, 52696, 53263, 52929, 52972, 57175, 55985, 52173, 53901, 58253, 57229, 54202, 54372] , new edges: [75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000] sum 5925000
100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 75/75 [32:47<00:00, 26.23s/it]
{'n_shards': 8, 'blocks_per_epoch': 50, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 56250, 'n_block': 30000, 'target_n_block': 30000.0, 'n_tx': 5625000, 'n_inner_tx': 1950974, 'n_cross_tx': 3674026, 'prop_cross_tx': 0.6531601777777778, 'n_block_tx': 6000000, 'n_block_out_tx': 2387415, 'n_block_forward_tx': 2386830, 'n_block_inner_tx': 1225755, 'throughput': 106.66666666666667, 'actual_throughput': 64.22373333333333, 'target_throughput': 106.66666666666667, 'tx_pool_length': [332870, 274700, 260042, 277592, 223834, 203718, 205340, 233734], 'tx_forward_length': [97, 74, 71, 63, 43, 124, 69, 44], 'n_wasted': 0, 'tx_wasted': [0, 0, 0, 0, 0, 0, 0, 0], 'prop_wasted': 0.0, 'prop_throughput': 0.6020975}
MSE: 0.35686415923379683 1.680719908285464 0.07160494796559111
Baseline MSE: 0.40233367322395885 1.9146256082769963 0.07900756806372604
Real MSE: 0.41310570085373705 1.680719908285464 0.07160494796559111
```

放大步长后仍无效。

## 修正新交易统计代码，重新运行

```sh
(arrl) qucheng@gpu01-inspur:~/ARRL$ python test_prediction.py --window=5 --n_blocks=50
Namespace(k=3, tx_rate=100, n_blocks=50, window=5)
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627660800 and timestamp<=1627747199
6346
select * from tx where block_number>=12927924 and block_number<=12934269
1222419
select * from block where timestamp>=1627747200
30874
select * from tx where block_number>=12934270
5939599
dropped 1239 contract creation tx, remaining: 1221180
dropped 5757 contract creation tx, remaining: 5933842
Account prediction:
Training prediction model: 1221180 1200000
Blocks: 0 ~ 15  Size: 16
Vertex from: 391821 Vertex to: 284874
Vertex: 523198
Layer: 16it [00:05,  3.18it/s]
Edge: 782749 , layer edges: [53550, 55716, 54911, 54377, 54983, 54207, 56980, 58006, 57372, 56417, 59842, 59043, 56852, 56283, 55849, 57282] , new edges: [53550, 51567, 49178, 47828, 47747, 46667, 49410, 50057, 49357, 48254, 52258, 50896, 47826, 46154, 45278, 46722] sum 782749
Train model: (782749, 16)
Train score: 0.5774637238929875 Coef: [0.07359044 0.15753768 0.15459072 0.47324352] Intercept: 0.0
Simulate on train txs: 1221180
 92%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                     | 11/12 [03:40<00:20, 20.06s/it]
{'n_shards': 8, 'blocks_per_epoch': 50, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 9000, 'n_block': 4800, 'target_n_block': 4800.0, 'n_tx': 900000, 'n_inner_tx': 293286, 'n_cross_tx': 606714, 'prop_cross_tx': 0.6741266666666667, 'n_block_tx': 960000, 'n_block_out_tx': 387659, 'n_block_forward_tx': 386984, 'n_block_inner_tx': 185357, 'throughput': 106.66666666666667, 'actual_throughput': 63.593444444444444, 'target_throughput': 106.66666666666667, 'tx_pool_length': [48229, 46531, 45724, 40178, 35865, 50745, 28439, 31273], 'tx_forward_length': [107, 117, 95, 97, 20, 47, 60, 132], 'n_wasted': 0, 'tx_wasted': [0, 0, 0, 0, 0, 0, 0, 0], 'prop_wasted': 0.0, 'prop_throughput': 0.5961885416666667}
MSE: 0.41887933006652406 0.6969477036745229 0.24043892021224358
Baseline MSE: 0.47690098720449764 0.9043872940112347 0.31216919472270166
Real MSE: 0.6547433042605825 0.6969477036745229 0.24043892021224358
Simulate on test txs: 5933842
Blocks: 0 ~ 78  Size: 79
Vertex from: 1428298 Vertex to: 1108120
Vertex: 1843370
Layer: 79it [00:44,  1.77it/s]
Edge: 3183377 , layer edges: [56360, 55061, 55400, 54195, 55178, 53807, 56968, 56064, 56040, 55490, 58926, 57961, 55911, 55401, 55731, 53944, 52915, 55198, 54594, 55896, 53000, 53796, 58264, 56266, 58901, 53849, 58833, 58469, 55916, 55241, 56799, 55604, 53416, 52960, 50960, 52773, 53639, 54110, 52947, 55635, 56274, 54976, 56576, 59412, 58120, 54129, 54091, 53642, 54881, 55413, 53725, 54300, 55555, 55003, 53886, 57391, 56720, 54346, 55430, 58778, 57868, 54323, 53620, 53794, 54186, 54511, 54734, 52696, 53263, 52929, 52972, 57175, 55985, 52173, 53901, 58253, 57229, 54202, 54372] , new edges: [56360, 51041, 50020, 47526, 47700, 45793, 49615, 48010, 48068, 47270, 52054, 50214, 46920, 45790, 45675, 43054, 40927, 43077, 42398, 42689, 39697, 40586, 42890, 43263, 47533, 41390, 43129, 45256, 43877, 42890, 43881, 41452, 39266, 38805, 37563, 38472, 38486, 39664, 37353, 37761, 38871, 38689, 37781, 39897, 42597, 38467, 37470, 37313, 38141, 38752, 37293, 37113, 37617, 37049, 36158, 34452, 36505, 36414, 36964, 34992, 37626, 36814, 34874, 35057, 35077, 34649, 36291, 35741, 35080, 35158, 35040, 33716, 33745, 33015, 34461, 32276, 34696, 34471, 35640] sum 3183377
100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 75/75 [31:24<00:00, 25.13s/it]
{'n_shards': 8, 'blocks_per_epoch': 50, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 56250, 'n_block': 30000, 'target_n_block': 30000.0, 'n_tx': 5625000, 'n_inner_tx': 1950974, 'n_cross_tx': 3674026, 'prop_cross_tx': 0.6531601777777778, 'n_block_tx': 6000000, 'n_block_out_tx': 2387415, 'n_block_forward_tx': 2386830, 'n_block_inner_tx': 1225755, 'throughput': 106.66666666666667, 'actual_throughput': 64.22373333333333, 'target_throughput': 106.66666666666667, 'tx_pool_length': [332870, 274700, 260042, 277592, 223834, 203718, 205340, 233734], 'tx_forward_length': [97, 74, 71, 63, 43, 124, 69, 44], 'n_wasted': 0, 'tx_wasted': [0, 0, 0, 0, 0, 0, 0, 0], 'prop_wasted': 0.0, 'prop_throughput': 0.6020975}
MSE: 0.35686415923379683 1.680719908285464 0.07160494796559111
Baseline MSE: 0.40233367322395885 1.9146256082769963 0.07900756806372604
Real MSE: 0.41310570085373705 1.680719908285464 0.07160494796559111
```

新交易比例极高，或许因此导致预测失效。  
以下为两个思路：  

1. 根据历史交易信息对可能出现的新交易进行预测。  
2. 根据历史信息对账户进行分组，并对分组间可能出现的交易进行预测。  
3. 综合账户余额和交易转账金额，Gas，手续费等信息进行预测。  

## 增大单步区块数到100，并增大预测窗口到10

```sh
Namespace(k=3, tx_rate=100, n_blocks=100, window=10, train_start_time='2021-07-30 00:00:00', train_end_time='2021-07-31 23:59:59', test_start_time='2021-08-01 00:00:00', test_end_time=None)
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627574400 and timestamp<=1627747199
12635
select * from tx where block_number>=12921635 and block_number<=12934269
2462906
select * from block where timestamp>=1627747200
30874
select * from tx where block_number>=12934270
5939599
dropped 2500 contract creation tx, remaining: 2460406
dropped 5757 contract creation tx, remaining: 5933842
Account prediction:
Training prediction model: 2460406 2400000
Blocks: 0 ~ 15  Size: 16
Vertex from: 710262 Vertex to: 516965
Vertex: 925552
Layer: 16it [00:09,  1.62it/s]
Edge: 1460836 , layer edges: [105761, 106151, 103805, 108310, 110890, 113016, 104505, 105826, 105010, 104948, 105101, 109277, 111404, 113912, 110453, 108687] , new edges: [105761, 98525, 93319, 96684, 98032, 100676, 89985, 89177, 85955, 84394, 82990, 85575, 87432, 89322, 88349, 84660] sum 1460836
Train model: (1460836, 16)
Train score: 0.7166482804285083 Coef: [0.02094778 0.04576617 0.1687325  0.00612203 0.01652455 0.01787442
 0.03765876 0.13815205 0.35989901] Intercept: 0.0
Simulate on train txs: 2460406
 86%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                     | 6/7 [05:20<00:53, 53.33s/it]
{'n_shards': 8, 'blocks_per_epoch': 100, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 10500, 'n_block': 5600, 'target_n_block': 5600.0, 'n_tx': 1050000, 'n_inner_tx': 420544, 'n_cross_tx': 629456, 'prop_cross_tx': 0.5994819047619048, 'n_block_tx': 1103062, 'n_block_out_tx': 412156, 'n_block_forward_tx': 411550, 'n_block_inner_tx': 279356, 'throughput': 105.05352380952381, 'actual_throughput': 65.80057142857143, 'target_throughput': 106.66666666666667, 'tx_pool_length': [62830, 40898, 59035, 59122, 49361, 43105, 44137, 0], 'tx_forward_length': [60, 80, 88, 85, 83, 28, 100, 82], 'n_wasted': 16938, 'tx_wasted': [0, 0, 0, 0, 0, 0, 0, 16938], 'prop_wasted': 0.015123214285714285, 'prop_throughput': 0.6168803571428572}
MSE: 0.5259112007731941 0.7257131725540303 0.36562965715278356
Baseline MSE: 0.8601795662866626 1.4039264477985862 0.5839089465734301
Real MSE: 1.0711049798099954 0.7257131725540303 0.36562965715278356
Simulate on test txs: 5933842
Blocks: 0 ~ 38  Size: 39
Vertex from: 1413250 Vertex to: 1099911
Vertex: 1827183
Layer: 39it [00:41,  1.05s/it]
Edge: 3147737 , layer edges: [107401, 105253, 104671, 109094, 107906, 113626, 107434, 105771, 103867, 106503, 102382, 110804, 109205, 113611, 107325, 108493, 102397, 99536, 103923, 104461, 107056, 112643, 108416, 103383, 106122, 103817, 106238, 107414, 107023, 110562, 108294, 102777, 103965, 103336, 102070, 106149, 104119, 108180, 107648] , new edges: [107401, 97546, 93493, 97625, 95338, 102268, 92710, 88729, 84004, 85087, 80283, 86153, 88923, 88385, 86767, 85333, 78071, 76035, 78150, 75114, 77560, 77678, 81064, 74783, 76893, 74406, 74666, 70610, 72919, 71956, 74440, 69931, 69726, 72032, 70238, 68756, 66760, 66737, 69167] sum 3147737
100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 30/30 [25:34<00:00, 51.14s/it]
{'n_shards': 8, 'blocks_per_epoch': 100, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 45000, 'n_block': 24000, 'target_n_block': 24000.0, 'n_tx': 4500000, 'n_inner_tx': 1905192, 'n_cross_tx': 2594808, 'prop_cross_tx': 0.576624, 'n_block_tx': 4796175, 'n_block_out_tx': 1762719, 'n_block_forward_tx': 1762102, 'n_block_inner_tx': 1271354, 'throughput': 106.58166666666666, 'actual_throughput': 67.41013333333333, 'target_throughput': 106.66666666666667, 'tx_pool_length': [274301, 217936, 229940, 216475, 153408, 141113, 75791, 156963], 'tx_forward_length': [78, 99, 75, 61, 68, 58, 139, 39], 'n_wasted': 3825, 'tx_wasted': [0, 0, 0, 0, 2362, 67, 1396, 0], 'prop_wasted': 0.000796875, 'prop_throughput': 0.63197}
MSE: 1.192916852875332 4.917839578784792 0.20124895657191522
Baseline MSE: 1.415886256967382 5.934107551308943 0.27222048532871734
Real MSE: 1.4418431717770575 4.917839578784792 0.20124895657191522
```

```sh
(arrl) qucheng@gpu01-inspur:~/ARRL$ python test_graph.py graph --method=past --past=9 --start_time="2021-08-01 00:00:00" --n_blocks=100
Namespace(funcs=['graph'], method=['past'], past=[9], k=3, g=10, tx_rate=100, n_blocks=100, start_time='2021-08-01 00:00:00', end_time=None)
Database Version: 5.7.34-0ubuntu0.18.04.1
select * from block where timestamp>=1627747200
30874
select * from tx where block_number>=12934270
5939599
dropped 5757 contract creation tx, remaining: 5933842
Account Graph:
Partition with past 9 steps txs:
 74%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                                   | 29/39 [20:03<06:55, 41.51s/it]
{'n_shards': 8, 'blocks_per_epoch': 100, 'tx_rate': 100, 'tx_per_block': 200, 'block_interval': 15, 'simulate_time': 45000, 'n_block': 24000, 'target_n_block': 24000.0, 'n_tx': 4500000, 'n_inner_tx': 1967216, 'n_cross_tx': 2532784, 'prop_cross_tx': 0.5628408888888888, 'n_block_tx': 4799764, 'n_block_out_tx': 1737582, 'n_block_forward_tx': 1737066, 'n_block_inner_tx': 1325116, 'throughput': 106.66142222222223, 'actual_throughput': 68.04848888888888, 'target_throughput': 106.66666666666667, 'tx_pool_length': [172281, 161906, 166481, 164218, 241162, 242191, 120382, 168681], 'tx_forward_length': [70, 74, 80, 77, 70, 68, 30, 47], 'n_wasted': 236, 'tx_wasted': [0, 0, 0, 0, 0, 0, 236, 0], 'prop_wasted': 4.9166666666666665e-05, 'prop_throughput': 0.6379545833333332}
```

没有变化，说明主要问题不是对已有交易的预测，而是对新交易和新账户的预测。

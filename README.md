# Repository for SwiftShard and further investigations

A sharded blockchain simulator with account allocation algorithms.

Note: TAB means Transaction Allocation in Blockchain, this repository is for researching about transaction allocating strategies in blockchain system.

## Requirements

**System**: 48 vCPUs, 128G Memory, 200G Disk (Recommended)

**OS**:  Ubuntu 18.04

Python 3.10, Metis 5.1.0, MySQL 14.14  

Dependencies:  
numpy, pandas, multiprocessing, gym, pymysql, tqdm, matplotlib, jupyter-notebook

## Data

The data is collected from Ethereum mainnet, from block 9437184 to 12965143, and converted to MySQL tables.  
The data is public avaliable now and can be downloaded from Figshare.  
<https://doi.org/10.6084/m9.figshare.25295767.v1>  

Note: You need to create a database named "arrl" and import "block" and "tx" tables from the downloaded data, the data is in SQL format and generated by mysqldump.  
Database connection configs can be changed in ./arrl/dataloader.py  

## Files

```bash
.
├── arrl                        : Dataloader and Dataset
├── data                        : Functions for retrieving test data from Ethereum (no use, use the database now)
├── env                         : Blockchain simulation environments
├── exp                         : Functions for logging, recording, ploting
├── fonts                       : Fonts
├── graph                       : Account graph construction & partition
├── images                      : Experiment result images and system design drawings
├── logs                        : Logs
├── metis                       : The Metis graph partition lib and save temp graph file
├── notes                       : Experiment notes
├── papers                      : Related or refered works
├── prediction                  : Experiments for predicting workload by ML
├── records                     : Experiment records
├── strategy                    : The account allocation strategy (dual address)
├── utils                       : Util functions
├── README.md                   : This file 
├── __init__.py
├── ablation_harmony_exp.sh     : Script for running ablation experiments
├── exp.sh                      : Example script for running a single experiment
├── loaddata.py                 : Print test data (no use, use the database now)
├── overhead_harmony_exp.sh     : Script for running parameter experiments
├── plot.ipynb                  : Jupyter notebook for ploting results
├── plot_for_paper.ipynb        : Jupyter notebook for ploting results
├── run_harmony_exp.sh          : Script for running the performance experiments
├── test_double.py              : Test code, for dual address
├── test_env.py                 : Test code, for simulation environments
├── test_graph.py               : Test code, for various account graph
├── test_harmony.py             : Main experiment script for SwiftShard using harmony simulator
├── test_munkres.py             : Test code, for the Munkres algorithm
├── test_plot.py                : Test code, for ploting functions
├── test_popular_graph.py       : Test code, for the popular graph
├── test_prediction.py          : Test code, for the transaction prediction with ML
├── test_rl.py                  : Test code, for allocating accounts with RL
├── test_stack.py               : Test code, for the graph stack
└── test_vpred.py               : Test code, for the workload prediction with ML
```

## Setup <a id="sec:setup"></a>

### 1. Install Anaconda3 and create a python environment, install all dependencies  

Get the anaconda installer from <https://www.anaconda.com/download#downloads>  
After anaconda is installed, create a python environment:

```bash
conda create -n arrl python=3.10 pip
conda activate arrl
```

Then all python packages can be installed through conda or pip. For example:

```bash
conda install numpy pandas gym pymysql tqdm matplotlib jupyter-notebook
```

### 2. Install Metis

Metis can be installed by apt or conda, for example:

```bash
sudo apt install metis
```

There are also a source code package in the path "./metis", more information refer to <http://glaros.dtc.umn.edu/gkhome>.

### 3. Install MySQL

```bash
sudo apt install mysql-server
```

<https://www.mysql.com/>

### 4. Download data, create database and import data

Download data.tar.gz from <https://doi.org/10.6084/m9.figshare.25295767.v1>

Unzip the data and get two files: block.sql, tx.sql

```bash
tar zvxf data.tar.gz
```

Create a database named arrl in MySQL database and import data:

```bash
mysql -e "create database arrl;"
```

```bash
mysql arrl < block.sql
mysql arrl < tx.sql
```

### 6. Compile and install mymetis

We implement this lib for enabling calling metis from python.

1. Commands make and g++ are required.
2. Edit setup.py, change python include paths and library paths according to your environment.
3. Install the mymetis library:

```bash
cd ./graph/mymetis
pip install -e .
```

### 7. Config paths in test_harmony.py

Edit test_harmony.py to change default output paths including experiment data, records, logs.

### 8. Run the test_harmony.py or experiment scripts

Refer to next section.

## Instructions

### Running experiments

The test_harmony.py is the main script for running the SwiftShard experiments.
The usage of test_harmony.py:

```bash
usage: test_harmony.py [-h] [-k K] [--n_shards N_SHARDS] [--tx_rate TX_RATE] [--n_blocks N_BLOCKS] [--tx_per_block TX_PER_BLOCK] [--block_interval BLOCK_INTERVAL] [--start_time START_TIME] [--end_time END_TIME] [--method {none,all,last,shard,pending}] [--double_addr]
                       [--compress [COMPRESS ...]] [--pmatch] [--overhead] [--n_epochs N_EPOCHS] [--save_path SAVE_PATH]

test harmony

options:
  -h, --help                                    : show usage
  -k K, --k K                                   : number of shards = 1<<k
  --n_shards N_SHARDS                           : number of shards (will overwrite -k)
  --tx_rate TX_RATE                             : transactions per second
  --n_blocks N_BLOCKS                           : number of blocks per epoch
  --tx_per_block TX_PER_BLOCK                   : maximum number of transactions per block
  --block_interval BLOCK_INTERVAL               : block interval
  --start_time START_TIME                       : start time of block data, in format '%Y-%m-%d %H:%M:%S' or '%Y-%m-%d'
  --end_time END_TIME                           : end time of block data, in format '%Y-%m-%d %H:%M:%S' or '%Y-%m-%d'
  --method {none,all,last,shard,pending}        : methods, explained below
  --double_addr                                 : whether to use dual address, only valid in shard method
  --compress [COMPRESS ...]                     : pruning parameters, 3 numbers (local graph edge weight pruning, local graph vertex weight pruning, global graph vertex weight pruning), only valid in shard method
  --pmatch                                      : whether to enable partition result matching, only valid in shard method
  --overhead                                    : whether to record overhead
  --n_epochs N_EPOCHS                           : number of epochs to run
  --save_path SAVE_PATH                         : save path of experiment data
```

Methods explaination:

```bash
none: allocate with account address
all: use all transaction history to construct the account graph
last: use transactions in last epoch to construct the account graph
shard: shards construct local graphs and broadcast and merge (SwiftShard)
pending: use pending transactions to construct the account graph
```

A running example can be found in exp.sh.

There are also some scirpts for running experiments in paper:

For example, to run the performance experiemnts with 16 shards and tx rate 3200:

```bash
./run_harmony_exp.sh 4 3200
```

The experiment records will be written by default to "./records/test_harmony", and the experiment data generated during running is saved by default to "/tmp/harmony", the logs are stored in "./logs/test_harmony.log".
These paths can be changed in the test_harmony.py.

### Plotting results

See the "plot.ipynb" or "plot_for_paper.ipynb", note you need to change the parameter of RecordPloter to the actual experiment record output path.

## Reproduce paper results

Step by step instructions to reproduce experiment results in paper "SwiftShard: Efficient Account Allocation with Low Overhead in Blockchain Sharding".

### 0. Prepare

Makesure the system and OS meet the requirements, follow the [Setup](#sec:setup) section to setup the experiment environment.

If experiment crashs due to OOM, make the ```max_prefetch``` parameter of ```TxLoader.__init__``` smaller may help, it can be changed in "./arrl/dataloader.py".

### 1. Performance Experiments

Following scripts can produce all performance results shown in the paper. Note it takes days to finish all experiments.

```bash
./run_harmony_exp.sh 1 200
./run_harmony_exp.sh 1 300
./run_harmony_exp.sh 1 400
./run_harmony_exp.sh 2 400
./run_harmony_exp.sh 2 600
./run_harmony_exp.sh 2 800
./run_harmony_exp.sh 3 800
./run_harmony_exp.sh 3 1200
./run_harmony_exp.sh 3 1600
./run_harmony_exp.sh 4 1600
./run_harmony_exp.sh 4 2400
./run_harmony_exp.sh 4 3200
./run_harmony_exp.sh 5 3200
./run_harmony_exp.sh 5 4800
./run_harmony_exp.sh 5 6400
mv ./records/test_harmony ./records/test_harmony_performance
```

Results are saved in ./records/test_harmony_performance.

### 2. Ablation Experiments

```bash
./ablation_harmony_exp.sh 4 3200
mv ./records/test_harmony ./records/test_harmony_ablation
```

Results are saved in ./records/test_harmony_ablation.

### 3. Parameter Sensitivity

```bash
./overhead_harmony_exp.sh 4 3200
mv ./records/test_harmony ./records/test_harmony_overhead
```

Results are saved in ./records/test_harmony_overhead

### 4. Transaction Analysis

Conduct the transaction analysis to produce "New Accounts and Edges" and "Cost and Coverage" figures.

```bash
python test_stack.py --type update --step_size 160000 --start_time="2021-07-20 00:00:00" --end_time="2021-08-05 00:00:00"
```

Results are saved in ./log/test_stack.log.

### 5. Plots

After all experiments results saved, open "plot_for_paper.ipynb" and run all cells to print all the experiment results and draw all figures in the paper.  

Note: If the matplotlib complain about fonts not found, copy font files in the ./fonts into the matplotlib package directory: ~/anaconda3/envs/arrl/lib/python3.10/site-packages/matplotlib/mpl-data/fonts/ttf

All the figures are saved in ./images.

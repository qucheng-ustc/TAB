# Repository for SwiftShard and further investigations

Note: TAB means Transaction Allocation in Blockchain, this repository is for researching about transaction allocating strategies in blockchain system.

## Requirements

Python 3.10, MySQL 14.14  

Dependencies:  
numpy, pandas, gym, pymysql, tqdm, matplotlib, jupyter-notebook

## Data

The data is collected from Ethereum mainnet, from block 9437184 to 12965143, and converted to MySQL tables.  
The data is public avaliable now and can be downloaded from Figshare.  
https://doi.org/10.6084/m9.figshare.25295767.v1  

Note: You need to create a database named "arrl" and import "block" and "tx" tables from the downloaded data, the data is in SQL format and generated by mysqldump.  
Database connection configs can be changed in ./arrl/dataloader.py  

## Files

```bash
.
├── arrl                        : Dataloader and Dataset
├── data                        : Functions for retrieving test data from Ethereum (no use, use the database now)
├── env                         : Blockchain simulation environments
├── exp                         : Functions for logging, recording, ploting
├── fonts                       : Fonts
├── graph                       : Account graph construction & partition
├── images                      : Experiment result images and system design drawings
├── logs                        : Logs
├── metis                       : The Metis graph partition lib
├── notes                       : Experiment notes
├── papers                      : Related or refered works
├── prediction                  : Experiments for predicting workload by ML
├── records                     : Experiment records
├── strategy                    : The account allocation strategy (dual address)
├── utils                       : Util functions
├── README.md                   : This file 
├── __init__.py
├── ablation_harmony_exp.sh     : Script for running ablation experiments
├── exp.sh                      : Example script for running a single experiment
├── loaddata.py                 : Print test data (no use, use the database now)
├── overhead_harmony_exp.sh     : Script for running parameter experiments
├── plot.ipynb                  : Jupyter notebook for ploting results
├── plot_for_paper.ipynb        : Jupyter notebook for ploting results
├── run_harmony_exp.sh          : Script for running the performance experiments
├── test_double.py              : Test code, for dual address
├── test_env.py                 : Test code, for simulation environments
├── test_graph.py               : Test code, for various account graph
├── test_harmony.py             : Main experiment script for SwiftShard using harmony simulator
├── test_munkres.py             : Test code, for the Munkres algorithm
├── test_plot.py                : Test code, for ploting functions
├── test_popular_graph.py       : Test code, for the popular graph
├── test_prediction.py          : Test code, for the transaction prediction with ML
├── test_rl.py                  : Test code, for allocating accounts with RL
├── test_stack.py               : Test code, for the graph stack
└── test_vpred.py               : Test code, for the workload prediction with ML
```

## Instructions

### Running experiments

The test_harmony.py is the main script for running the SwiftShard experiments.
The usage of test_harmony.py:

```bash
usage: test_harmony.py [-h] [-k K] [--n_shards N_SHARDS] [--tx_rate TX_RATE] [--n_blocks N_BLOCKS] [--tx_per_block TX_PER_BLOCK] [--block_interval BLOCK_INTERVAL] [--start_time START_TIME] [--end_time END_TIME] [--method {none,all,last,shard,pending}] [--double_addr]
                       [--compress [COMPRESS ...]] [--pmatch] [--overhead] [--n_epochs N_EPOCHS] [--save_path SAVE_PATH]

test harmony

options:
  -h, --help                                    : show usage
  -k K, --k K                                   : number of shards = 1<<k
  --n_shards N_SHARDS                           : number of shards (will overwrite -k)
  --tx_rate TX_RATE                             : transactions per second
  --n_blocks N_BLOCKS                           : number of blocks per epoch
  --tx_per_block TX_PER_BLOCK                   : maximum number of transactions per block
  --block_interval BLOCK_INTERVAL               : block interval
  --start_time START_TIME                       : start time of block data, in format '%Y-%m-%d %H:%M:%S' or '%Y-%m-%d'
  --end_time END_TIME                           : end time of block data, in format '%Y-%m-%d %H:%M:%S' or '%Y-%m-%d'
  --method {none,all,last,shard,pending}        : methods, explained below
  --double_addr                                 : whether to use dual address, only valid in shard method
  --compress [COMPRESS ...]                     : pruning parameters, 3 numbers (local graph edge weight pruning, local graph vertex weight pruning, global graph vertex weight pruning), only valid in shard method
  --pmatch                                      : whether to enable partition result matching, only valid in shard method
  --overhead                                    : whether to record overhead
  --n_epochs N_EPOCHS                           : number of epochs to run
  --save_path SAVE_PATH                         : save path of experiment data
```

Methods explaination:

```bash
none: allocate with account address
all: use all transaction history to construct the account graph
last: use transactions in last epoch to construct the account graph
shard: shards construct local graphs and broadcast and merge
pending: use pending transactions to construct the account graph
```

A running example can be found in exp.sh.

There are also some scirpts for running experiments in paper:

For example, to run the performance experiemnts with tx rate 3200 and 16 shards:

```bash
./run_harmony_exp.sh 4 3200
```

The experiment records will be written by default to "./records/test_harmony", and the experiment data generated during running is saved by default to "/tmp/harmony", the logs are stored in "./logs/test_harmony.log".
These directories can be changed in the test_harmony.py.

### Plotting results

See the "plot.ipynb" or "plot_for_paper.ipynb", note you need to change the parameter of RecordPloter to the actual experiment record output path.
